# 功能规格说明书：美股预测仪表盘

**功能分支**：`001-us-predict-dashboard`
**创建日期**：2025-10-22
**状态**：草稿
**概述**：构建一个极简美股股价预测仪表盘。用户可输入美股代码查看过去 90 天的收盘价折线图；可选择简单移动平均（SMA）外推查看未来 3 天预测；可选择时间序列预测查看未来 5 天并展示置信区间。页面须在 1.5 秒内对有效请求完成渲染。所有核心数据获取与预测逻辑需可单元测试、可 mock，且不得依赖全局状态或文件系统。

## 用户场景与测试 _(必填)_

### 用户故事 1 - 查询历史与展示（Priority: P1）

描述：用户输入股票代码（例如 `AAPL`），系统展示过去 90 天收盘价折线图，图表下方展示数据来源与最后更新时间。

为什么优先级高：这是最基础且直接为用户提供价值的功能，构成 MVP。

独立测试：对有效代码（例如 AAPL）与无效代码（例如 XYZINVALID）分别验证：

- 有效代码：请求返回后 1.5 秒内页面渲染折线图并显示最后更新时间。
- 无效代码：显示友好错误提示（示例："无法找到该代码，请检查输入"）。

验收场景：

1. 给定有效代码并有足够历史数据（>= 90 天），当用户提交查询，页面在 1.5 秒内展示折线图与最后更新时间。
2. 给定无效代码，系统返回友好错误提示并指示用户检查输入。

---

### 用户故事 2 - SMA 外推预测（Priority: P2）

描述：用户选择“3 天 SMA 外推”，系统基于最近历史价格展示未来 3 天的预测值（点线或小范围区间），并在界面说明方法为简单移动平均外推。

独立测试：对一段已知历史价格运行 `predict_next_prices(prices, days=3)`（可单元测试）并断言返回的预测值数目为 3 且类型为数值列表。

验收场景：

1. 输入历史价格序列，调用 SMA 外推并返回 3 个未来日的预测值；界面在预测区域显示方法名称与最后更新时间。

---

### 用户故事 3 - 时间序列预测（Priority: P3，可选）

描述：用户选择“5 天时间序列预测”，系统展示未来 5 天的预测值并同时给出置信区间（若启用该模型）。

独立测试：在可控环境下（数据 mock），运行时间序列预测流程并验证输出包含 `predicted_prices: List[float]` 与可选的 `confidence_interval: List[Tuple[float,float]]`。

验收场景：

1. 提供足够历史数据（>= 60 天建议），运行模型并在界面展示 5 天预测及置信区间；若模型未启用，界面应提示该功能受限并说明原因。

---

### 边界与异常

- 网络或数据源不可用：显示“数据暂不可用，请稍后重试”。
- 历史数据不足（少于 20 天）：拒绝预测并提示"历史数据不足，无法生成可靠预测"。
- 短时延迟或超时：若在 1.5 秒内未能渲染完整图表，应先展示可用静态占位并提示仍在加载。

## 功能需求 _(可测试、可验收)_

### 功能性需求

- **FR-001**：系统 MUST 接受用户输入的美股代码并返回过去 90 天的收盘价数据（当数据可用时）。
- **FR-002**：系统 MUST 在有效请求下于 1.5 秒内渲染历史折线图（P1 验收标准）。
- **FR-003**：系统 MUST 提供 SMA 外推功能，核心可测试函数为 `predict_next_prices(prices: List[float], days: int = 3) -> List[float]`，并保证该函数可在单元测试环境中运行（不依赖网络或文件）。
- **FR-004**：系统 SHOULD 支持时间序列预测功能以返回未来 5 天预测与置信区间；若启用该功能，必须记录在规格中并在界面上注明该功能为“可选/受限”。
- **FR-005**：系统 MUST 在页面显著位置显示免责声明：“本预测不构成投资建议”。
- **FR-006**：系统 MUST 在预测与历史数据展示处显示最后更新时间。
- **FR-007**：系统 MUST 对无效或不存在的股票代码返回清晰的用户友好错误信息。
- **FR-008**：数据获取函数 `fetch_prices(ticker: str) -> List[float]` MUST 可 mock，并且不应依赖全局状态或文件系统。
- **FR-009**：所有预测逻辑应为可测试（纯函数或通过依赖注入），不得在函数内部进行网络请求或直接读写文件。

### 非功能性需求

- **NFR-001**：界面交互响应时间目标：95% 的有效请求在 1.5 秒内完成初次渲染。
- **NFR-002**：预测功能在数据足够的前提下，结果应有一致性（同一输入在短期内重复调用结果可比）。

## 关键实体

- `ticker`：股票代码字符串（例如 AAPL）
- `prices`：历史收盘价序列，按日期升序排列的浮点数列表
- `predicted_prices`：未来若干日的预测收盘价列表
- `confidence_interval`：每个预测值对应的可选置信区间（低, 高）

## 成功标准 _(可验证、可量化、面向用户)_

- **SC-001**：对有效股票代码的查询，95% 的请求在 1.5 秒内展示历史折线图并显示最后更新时间。
- **SC-002**：SMA 外推函数在给定历史数据时能返回与 `days` 相同数量的预测点且数据类型正确（数值列表）；该行为通过单元测试覆盖。
- **SC-003**：当启用时间序列预测时，系统能在 95% 的合理输入情况下返回 5 天预测值与置信区间（若该功能未启用，则应在界面明确注明）。
- **SC-004**：所有错误/异常场景均向用户呈现友好且可操作的提示文本。
- **SC-005**：页面显著位置始终展示免责声明与最后更新时间。

## 依赖与假设

- 假设能获取到经授权或公开的历史市场数据源；数据延迟或不可用应被视为运行风险。
- 宪法/治理要求：项目优先“依赖最小化”和“可测性”；若要引入第三方时间序列库（例如 Prophet），需额外审批并记录安全/许可影响（宪法默认对 Prophet 等大型外部 ML 库持限制态度）。
- 在实现阶段，应遵守代码规范（PEP8、mypy --strict、pytest）与单文件行数限制（<=250 行）等约定。

## 可扩展项（非必须）

- 支持不同时间窗口（例如 30/60/180 天）作为用户可选项，但不作为 MVP 的必须项。

## 附录：验收测试要点

1. 功能测试：有效/无效代码查询、SMA 输出形状与类型、时间序列（若启用）输出与置信区间。
2. 性能测试：在受控环境下测量 95% 请求的渲染时间小于 1.5 秒。
3. 安全/合规：页面展示免责声明，且若引入受限库需审批记录。

---

**说明**：若对时间序列模型的具体库或算法有偏好，请在 `/speckit.clarify` 中指出；若不指示，我方将以最小依赖原则推荐轻量实现或封装第三方模型为可选插件。
These must be technology-agnostic and measurable.
